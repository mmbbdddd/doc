### 概述
聚合根是通向软件架构的信息根，但如何从这个点，扩展出整个软件设计，依然充满了很多挑战。

事实上， 直接跳过任何架构设计方法步骤（包括本文的前2/3的内容）并不方案大多数人仅凭拍脑袋也能规划处一个相当不错的架构。
如果按照一些架构方法论，比如TOGAF要求的业务架构、数据架构、应用架构、技术架构....看起来会更前面完整一点。并且这样的
架构在大多数时候表现良好。

实际上，这意味着这些领域不足够复杂，根本不需要架构。或者，他还没有成长为足够复杂，呈现出需求实现、bug频发、bug修复
问题更多.....效率越来越低.....稳定性越来越差的阶段。
 
brooks在《人月神话》中提到：架构设计最重要的因素是“概念完整性”，不过他那个时代并没有对如何形成概念完整性有什么系统的
方法。

在《领域驱动》一书中，evens应该已经清晰的构建了这个方法体系的一角（聚合根），不过他并没有大大方方的把它完整展示出来。

其实，这方法背后的原理相当简单

    1，聚合根决定架构形状，聚合根对于构建领域模型有非常重要的意义
    2，并非所有领域都存在领域架构，但依然可以构建领域架构
    3，在领域架构核心代码实现上，存在一套几乎通用的模板：实体，值对象，仓储工厂，防腐层

可以通过如下的流程来按部就班的实现这一点

### 领域建模
#### 流程

流程在架构设计中的地位是最重要的。

中国人讲纲举目张，流程就是架构中的纲。

流程同样是领域建模中必须首先抓住，首先分析的东西。
**从业务角度，**流程分析必须首要明确客户、然后对整个流程进行价值链分析优化。

SAP之所以优秀，并不是软件优秀，而是他所谓的“流程再造”方法论。——在SAP实施之前，咨询公司会先入场针对客户的业务给出
给出解决方案，重塑客户的业务流程。如果客户接受，再实施；如果不接受方案，那基本不会单独进行软件部署实施。

国内虽然99%的项目中不会进行流程再造————毕竟国内瞎逼逼乱来忽悠客户的也不在少数，按照既有成熟模式逐步推进还是比较
稳妥的。

**从技术的架构设计角度讲，**
其实什么客户啦、价值链了其实都不关心。架构分析关心的是
* 聚合根是谁
* 他的状态变化阶段有那些？是不是多变的？
* 每个阶段的业务变化是什么 

这决定了整个架构的流程实现模式是什么。如果流程是简单的，不变的，直接代码实现就好了，如果流程是简单变化的，那么架构师就很
可能寻求PIPLINE或者状态机来支持。如果流程是多变的且系统业务量非常大，那就必须使用特定的流程编排软件+研发团队维护；而如果
并发两比较小，那么可以考虑引入工作流解决。

这还决定了：业务词典——整个软件的体系复杂度。

#### 业务词典
假设一个支付系统，那么其交易订单表的业务词典可能是这样的

    pay_trade_order
    卖家：mall_id;ID
    卖家类型：普通小商家，VIP付费小商家，大客户、VIP付费大客户.....:枚举值对象
    买家ID：user_id:ID
    买家类型：穷鬼/VIP/有钱人/有钱人且舍得花钱的VIP。。。。。。:枚举值对象
    支付金额：amount：数据类型
    支付渠道：alipay，weixinPay，abc，psbc，.....：枚举值对象
.......
上面每一个枚举值对象都必然对应一套嵌入在流程某个环节的业务逻辑来处理他。

        掌握了流程+业务词典就基本掌握了业务架构

大部分时候，我并不喜欢直接去数据库中去distict某表某列去了解值对象————很多数据存的都并不是人能看懂的枚举name
比如alipay会映射为1，weixinpay会映射为2.。。。。映射规则可能是在数据库注释中，或者代码的某一行注释中，也可能
哪里都没有。不过幸运的是数据库是相对可靠的。

 

#### 事件风暴
实际上，大多数时候，我都不会去数据库中看那些值对象。 

新项目，没有它 

老项目，即使分析的再完整，也是过去，不代表未来的可能。

实际上，更重要的是业务、技术……等在一起，顺着流程去理解、分析、甚至脑爆业务的每一种可能和价值。



### 架构设计
#### 数据架构
所有的数据库表有三种身份：业务流水表、配置表、其他。
比如支付系统中

| Syntax           | Description |
|------------------|-------------|
| trade_type       | 配置表         |
| trade_order      | 流水表         |
| pay_channel      | 配置表         | 
| dicts            | 其他          |
| trade_order_logs | 其他          | 
| citys            | 其他          | 


所有高频变化的东西，都应该设计到配置文件或者配置表中。 
何谓高频变化：低于或者接近于一个发布周期的就是高频变化。

配置表的本质并不是数据，而是代码。
其做成了配置，必然是需要一个东西来导入、组装成代码的。（参见vof项目）



#### 分层结构/应用架构  


#### 接口设计  
### 架构落地 
#### 对象流程图 
#### 测试驱动
#### 图码一体
#### 重构1：技术和业务分离
#### 重构2：变化和不变分离（值对象）
#### 重构3：回到大气层：适应分层架构和应用架构